<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Astronave con SLAM</title>
  
  <!-- A-Frame for AR rendering -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <!-- AR.js for markerless AR (useful for mobile AR with camera feed) -->
  <script src="https://aframe.io/releases/1.2.0/aframe-ar.js"></script>
  <!-- OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()" onerror="onOpenCvError()"></script>

  <style>
    body { margin: 0; overflow: hidden; }
    #video, #canvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
    a-scene { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
    #debugCanvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 2; pointer-events: none; }
  </style>
</head>
<body>

<!-- A-Frame scene with AR.js enabled -->
<a-scene embedded vr-mode-ui="enabled: false" renderer="antialias: true;" arjs="sourceType: webcam; debugUIEnabled: false;">
  <a-assets>
    <!-- Load the 3D model of the spaceship -->
    <a-asset-item id="astro" src="ASTRONAVE.glb"></a-asset-item>
  </a-assets>

  <!-- Astronave 3D da visualizzare nell'AR -->
  <a-entity id="astronave" gltf-model="#astro" scale="0.7 0.7 0.7" position="0 0 0" rotation="0 0 0"></a-entity>

  <!-- Camera per il rendering AR -->
  <a-camera position="0 0 0" look-controls="enabled: true"></a-camera>
</a-scene>
<video id="video" autoplay></video>
<canvas id="canvas"></canvas>
<!-- Script per l'orientamento del dispositivo -->
<script>
  let alpha = 0, beta = 0, gamma = 0;
  let cameraEntity = document.querySelector('a-camera');
  let astronaveEntity = document.querySelector('#astronave');

  // Gestire l'orientamento del dispositivo
  function handleOrientation(event) {
    alpha = event.alpha ? THREE.MathUtils.degToRad(event.alpha) : 0; // Yaw
    beta = event.beta ? THREE.MathUtils.degToRad(event.beta) : 0;   // Pitch
    gamma = event.gamma ? THREE.MathUtils.degToRad(event.gamma) : 0; // Roll
    
    // Ruota la camera secondo l'orientamento del dispositivo
    cameraEntity.object3D.rotation.set(beta, alpha, gamma);

    // Posizionare l'astronave a una certa distanza
    astronaveEntity.object3D.position.set(0, 0, -5);
    astronaveEntity.object3D.lookAt(cameraEntity.object3D.position);
  }

  // Aggiungi listener per i cambiamenti di orientamento del dispositivo
  window.addEventListener('deviceorientation', handleOrientation, true);
</script>

<script>
  // OpenCV Ready
  function onOpenCvReady() {
    console.log('OpenCV.js Ã¨ pronto.');
  }

  function onOpenCvError() {
    console.log('Errore nel caricamento di OpenCV.js.');
  }
</script>

</body>
</html>
